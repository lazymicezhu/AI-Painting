<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIç»˜ç”»ç½‘é¡µ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #3d5af1;
      --primary-light: #4e6af2;
      --primary-dark: #2e48d0;
      --accent: #22e3dd;
      --accent-hover: #04f9f1;
      --background: #0f1129;
      --card-bg: #171b36;
      --text: #eef1ff;
      --text-secondary: #8d91b0;
      --border: #252a48;
      --success: #05d77e;
      --error: #ff5367;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background-color: var(--background);
      color: var(--text);
      font-family: 'Noto Sans SC', sans-serif;
      line-height: 1.6;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
      padding: 10px;
    }
    
    /* ç§‘æŠ€ç½‘æ ¼èƒŒæ™¯ */
    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        linear-gradient(rgba(62, 79, 233, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(62, 79, 233, 0.05) 1px, transparent 1px);
      background-size: 25px 25px;
      z-index: -1;
      pointer-events: none;
    }
    
    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 40px;
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4), 
                  0 0 0 1px rgba(255, 255, 255, 0.08), 
                  0 0 30px rgba(61, 90, 241, 0.3);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      body {
        padding: 5px;
      }
      
      .container {
        margin: 10px auto;
        padding: 20px;
        border-radius: 12px;
      }
      
      h2 {
        font-size: 28px;
        margin-bottom: 20px;
      }
      
      input[type="text"], input[type="file"] {
        padding: 15px;
        font-size: 16px;
      }
      
      button {
        padding: 12px 20px;
        font-size: 15px;
      }
      
      #submitBtn, #describeBtn {
        height: 50px;
        font-size: 16px;
      }
      
      .mode-option {
        padding: 12px;
      }
      
      .mode-option span {
        font-size: 16px;
      }
      
      .function-tabs button {
        padding: 12px 0;
        font-size: 16px;
      }
      
      .variation-btns {
        padding: 15px;
        gap: 12px;
      }
      
      .description {
        padding: 15px;
        font-size: 13px;
      }
    }
    
    @media (max-width: 480px) {
      .container {
        padding: 15px;
      }
      
      h2 {
        font-size: 24px;
      }
      
      .function-tabs {
        flex-direction: column;
        gap: 8px;
      }
      
      .function-tabs button {
        border-radius: 8px;
      }
      
      .mode-option {
        padding: 10px;
      }
      
      .mode-option span {
        font-size: 14px;
      }
      
      .mode-option small {
        font-size: 11px;
      }
      
      .variation-btns {
        padding: 12px;
      }
      
      .variation-btns button {
        padding: 6px 8px;
        font-size: 12px;
      }
      
      .variation-btns > div {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .variation-btns > div > div:first-child {
        min-width: auto;
        margin-bottom: 5px;
      }
      
      .button-group {
        width: 100%;
      }
    }
    
    /* éœ“è™¹å…‰è¾¹æ¡†æ•ˆæœ */
    .container::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, var(--primary), var(--accent), var(--primary), var(--accent));
      z-index: -1;
      border-radius: 14px;
      background-size: 400%;
      animation: borderAnimation 8s linear infinite;
      filter: blur(6px);
      opacity: 0.6;
    }
    
    @keyframes borderAnimation {
      0% { background-position: 0 0; }
      50% { background-position: 100% 0; }
      100% { background-position: 0 0; }
    }
    
    h2 {
      text-align: center;
      color: var(--text);
      font-family: 'Rajdhani', sans-serif;
      font-weight: 700;
      font-size: 36px;
      margin-bottom: 30px;
      position: relative;
      letter-spacing: 1.2px;
      text-shadow: 0 0 15px rgba(34, 227, 221, 0.8);
      background: linear-gradient(45deg, var(--text), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    h2::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 3px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border-radius: 3px;
    }
    
    input[type="text"] {
      width: 100%;
      margin-bottom: 20px;
      padding: 18px;
      font-size: 16px;
      background: rgba(15, 17, 41, 0.9);
      border: 2px solid transparent;
      border-radius: 12px;
      color: var(--text);
      transition: all 0.3s ease;
      font-family: inherit;
      backdrop-filter: blur(5px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    input[type="text"]:focus {
      outline: none;
      border: 2px solid var(--primary);
      box-shadow: 0 0 0 4px rgba(61, 90, 241, 0.25), 
                  0 8px 25px rgba(61, 90, 241, 0.15);
      transform: translateY(-2px);
    }
    
    input[type="file"] {
      margin-bottom: 20px;
      background: rgba(15, 17, 41, 0.9);
      border: 2px solid transparent;
      border-radius: 12px;
      padding: 15px;
      width: 100%;
      color: var(--text-secondary);
      position: relative;
      backdrop-filter: blur(5px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }
    
    input[type="file"]::file-selector-button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 15px;
      transition: background 0.2s;
    }
    
    input[type="file"]::file-selector-button:hover {
      background: var(--primary-light);
    }
    
    button {
      padding: 15px 30px;
      font-size: 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      font-family: inherit;
      letter-spacing: 0.8px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 6px 20px rgba(61, 90, 241, 0.3);
    }
    
    button:hover {
      background: var(--primary-light);
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(46, 72, 208, 0.5);
    }
    
    button:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(46, 72, 208, 0.4);
    }
    
    button:disabled {
      background: rgba(61, 90, 241, 0.5);
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    
    /* æŒ‰é’®ç‚¹å‡»æ³¢æµªæ•ˆæœ */
    button::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%);
      transform-origin: 50% 50%;
    }
    
    @keyframes ripple {
      0% {
        transform: scale(0, 0);
        opacity: 0.5;
      }
      100% {
        transform: scale(20, 20);
        opacity: 0;
      }
    }
    
    button:focus:not(:active)::after {
      animation: ripple 0.8s ease-out;
    }
    
    .result {
      margin-top: 20px;
      white-space: pre-wrap;
      word-break: break-all;
      line-height: 1.6;
      color: var(--text);
    }
    
    /* è¿›åº¦æ¡æ ·å¼ */
    .progress-bar {
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 15px;
    }
    
    .progress-bar div {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      transition: width 0.3s ease;
      position: relative;
    }
    
    .progress-bar div::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: shimmer 1.5s infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    .description {
      margin-top: 20px;
      background: rgba(15, 17, 41, 0.7);
      padding: 18px;
      border-radius: 12px;
      border-left: 4px solid var(--accent);
      font-size: 14px;
      color: var(--text-secondary);
      backdrop-filter: blur(5px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    /* å˜åŒ–æŒ‰é’®æ ·å¼ */
    .variation-btns {
      margin-top: 25px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      background: rgba(15, 17, 41, 0.7);
      padding: 20px;
      border-radius: 12px;
      backdrop-filter: blur(5px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .variation-btns button {
      min-width: 50px;
      font-size: 14px;
      padding: 8px 12px;
    }
    
    .variation-btns div {
      font-family: 'Rajdhani', sans-serif;
      font-weight: 600;
    }
    
    .variation-btns > div {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .variation-btns > div > div:first-child {
      min-width: 100px;
      white-space: nowrap;
    }
    
    .button-group {
      display: flex;
      gap: 5px;
      flex: 1;
      flex-wrap: wrap;
    }
    
    .button-group button {
      flex: 1;
    }
    
    /* å°å‹æŒ‰é’®æ ·å¼ */
    .btn-small {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--text);
    }
    
    .btn-small:hover {
      background: rgba(61, 90, 241, 0.1);
    }
    
    .btn-u {
      border-color: #4a58e8;
      color: #4a58e8;
    }
    
    .btn-v {
      border-color: #22e3dd;
      color: #22e3dd;
    }
    
    .btn-reroll {
      background: linear-gradient(90deg, #3d5af1, #22e3dd);
      border: none;
    }
    
    .history-item {
      margin-top: 35px;
      border-top: 2px solid var(--border);
      padding-top: 35px;
      position: relative;
      backdrop-filter: blur(5px);
    }
    
    .history-label {
      position: absolute;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card-bg);
      padding: 0 20px;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 1.2px;
      font-family: 'Rajdhani', sans-serif;
      text-transform: uppercase;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }
    
    .history-container {
      margin-top: 30px;
    }
    
    /* å›¾ç‰‡æ•ˆæœ */
    img {
      border-radius: 12px;
      transition: all 0.3s ease;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }
    
    img:hover {
      transform: scale(1.03);
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.5);
    }
    
    #submitBtn {
      width: 100%;
      background: linear-gradient(45deg, var(--primary), var(--accent));
      background-size: 200% 200%;
      animation: gradientBG 5s ease infinite;
      font-weight: 700;
      font-size: 18px;
      height: 55px;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(61, 90, 241, 0.4);
    }
    
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    /* åŠ è½½å®Œæˆçš„åŠ¨ç”»æ•ˆæœ */
    .loaded-animation {
      animation: successPulse 1s ease-out;
    }
    
    @keyframes successPulse {
      0% { box-shadow: 0 0 0 0 rgba(34, 227, 221, 0.7); }
      70% { box-shadow: 0 0 0 15px rgba(34, 227, 221, 0); }
      100% { box-shadow: 0 0 0 0 rgba(34, 227, 221, 0); }
    }
    
    /* æ·»åŠ æ¨¡å¼é€‰æ‹©æ ·å¼ */
    .mode-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px;
      background: rgba(15, 17, 41, 0.8);
      border: 2px solid transparent;
      border-radius: 12px;
      cursor: pointer;
      flex: 1;
      transition: all 0.3s ease;
      position: relative;
      backdrop-filter: blur(5px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .mode-option:hover {
      border: 2px solid var(--primary);
      background: rgba(61, 90, 241, 0.15);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(61, 90, 241, 0.3);
    }
    
    .mode-option input[type="radio"] {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .mode-option span {
      font-family: 'Rajdhani', sans-serif;
      font-weight: 600;
      font-size: 18px;
      color: var(--text);
      margin-bottom: 4px;
    }
    
    .mode-option small {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .mode-option input[type="radio"]:checked + span {
      color: var(--accent);
    }
    
    .mode-option input[type="radio"]:checked ~ small {
      color: var(--accent);
    }
    
    /* ç¡®ä¿æ ‡ç­¾é¢œè‰²ä¸å—é€‰ä¸­çŠ¶æ€å½±å“ */
    .mode-option input[type="radio"]:checked ~ .mode-badge,
    .mode-option input[type="radio"]:checked ~ .disabled-badge {
      /* ä¿æŒæ ‡ç­¾åŸæœ‰çš„é¢œè‰²ï¼Œä¸ç»§æ‰¿é€‰ä¸­çŠ¶æ€çš„é¢œè‰² */
      color: white !important;
    }
    
    .mode-option input[type="radio"]:checked ~ span::after {
      content: "";
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 100%;
      height: 2px;
      background: var(--accent);
    }
    
    .mode-option input[type="radio"]:checked + span::after {
      content: "";
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 100%;
      height: 2px;
      background: var(--accent);
    }
    
    .mode-option input[type="radio"]:checked ~ span::after {
      content: "";
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 100%;
      height: 2px;
      background: var(--accent);
    }
    
    .mode-option input[type="radio"]:checked ~ * {
      color: var(--accent);
    }
    
    /* æ·»åŠ æ ‡ç­¾æ ·å¼ */
    .mode-option.has-badge {
      position: relative;
      overflow: hidden;
    }
    
    .mode-badge {
      position: absolute;
      top: 0;
      right: 0;
      color: white;
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 0 8px 0 8px;
      font-weight: 600;
      z-index: 2;
    }
    
    .yellow-badge {
      background: #e67e22;
      color: #ffffff;
      text-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
    }
    
    .green-badge {
      background: #05d77e;
    }
    
    /* ç¦ç”¨æ¨¡å¼æ ·å¼ */
    .mode-option.disabled {
      opacity: 0.6;
      cursor: not-allowed;
      position: relative;
      overflow: hidden;
    }
    
    .mode-option.disabled::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.2);
      z-index: 1;
    }
    
    .disabled-badge {
      position: absolute;
      top: 0;
      right: 0;
      background: var(--error);
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 0 4px 0 4px;
      z-index: 2;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>AIç»˜ç”»ç”Ÿæˆå™¨</h2>
    <div class="function-tabs" style="display:flex; margin-bottom:25px; gap:12px; flex-wrap: wrap;">
      <button id="tab-generate" class="tab-btn active" style="flex:1; padding:15px 0; font-size:17px; border:none; border-radius:12px 12px 0 0; background:var(--primary); color:#fff; font-weight:600; box-shadow: 0 4px 15px rgba(61, 90, 241, 0.3); transition: all 0.3s ease;">ç”Ÿæˆå›¾åƒ</button>
      <button id="tab-describe" class="tab-btn" style="flex:1; padding:15px 0; font-size:17px; border:none; border-radius:12px 12px 0 0; background:var(--card-bg); color:var(--text-secondary); font-weight:600; transition: all 0.3s ease;">å›¾ç”Ÿæ–‡ï¼ˆDescribeï¼‰</button>
    </div>
    <div id="generate-section">
      <input type="text" id="prompt" placeholder="è¯·è¾“å…¥æç¤ºè¯..." />
      <input type="file" id="imageInput" accept="image/*" />
      <div style="margin: 20px 0; padding: 20px; background: rgba(15, 17, 41, 0.7); border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); backdrop-filter: blur(5px);">
        <div style="margin-bottom: 15px; font-family:'Rajdhani',sans-serif; font-weight:700; font-size:18px; color:var(--text);">ç»˜å›¾æ¨¡å¼</div>
        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
          <label class="mode-option has-badge">
            <input type="radio" name="drawingMode" value="relax" checked>
            <span>Relax</span>
            <small>å¸¸è§„æ¨¡å¼</small>
            <div class="mode-badge yellow-badge">60-90s</div>
          </label>
          <label class="mode-option has-badge">
            <input type="radio" name="drawingMode" value="fast">
            <span>Fast</span>
            <small>å¿«é€Ÿæ¨¡å¼</small>
            <div class="mode-badge green-badge">30-60s</div>
          </label>
          <label class="mode-option disabled" title="Turboæ¨¡å¼æš‚æ—¶ä¸å¯ç”¨ï¼Œæˆæœ¬è¾ƒé«˜">
            <input type="radio" name="drawingMode" value="turbo" disabled>
            <span>Turbo</span>
            <small>æé€Ÿæ¨¡å¼</small>
            <div class="disabled-badge">æˆæœ¬è¾ƒé«˜</div>
          </label>
        </div>
      </div>
      <button id="submitBtn">ç”Ÿæˆå›¾åƒ</button>
    </div>
    <div id="describe-section" style="display:none;">
      <input type="file" id="describeImageInput" accept="image/*" />
      <button id="describeBtn" style="margin-bottom:20px;width:100%;background:linear-gradient(45deg,#22e3dd,#3d5af1);font-weight:700;font-size:18px;height:55px;border-radius:12px;box-shadow: 0 6px 20px rgba(34, 227, 221, 0.3);transition: all 0.3s ease;">å›¾ç”Ÿæ–‡ï¼ˆDescribeï¼‰</button>
    </div>
    <div id="historyContainer" class="history-container"></div>
  </div>
  <script src="config.js"></script>
  <script>
    const API_URL = window.AI_CONFIG.API_URL;
    const API_TOKEN = window.AI_CONFIG.API_TOKEN;
    const promptInput = document.getElementById('prompt');
    const imageInput = document.getElementById('imageInput');
    const submitBtn = document.getElementById('submitBtn');
    const historyContainer = document.getElementById('historyContainer');
    const describeBtn = document.getElementById('describeBtn');
    const describeImageInput = document.getElementById('describeImageInput');
    
    let currentTaskId = null;

    // Tabåˆ‡æ¢é€»è¾‘
    const tabGenerate = document.getElementById('tab-generate');
    const tabDescribe = document.getElementById('tab-describe');
    const generateSection = document.getElementById('generate-section');
    const describeSection = document.getElementById('describe-section');
    tabGenerate.onclick = function() {
      tabGenerate.classList.add('active');
      tabDescribe.classList.remove('active');
      tabGenerate.style.background = 'var(--primary)';
      tabGenerate.style.color = '#fff';
      tabGenerate.style.boxShadow = '0 4px 15px rgba(61, 90, 241, 0.3)';
      tabDescribe.style.background = 'var(--card-bg)';
      tabDescribe.style.color = 'var(--text-secondary)';
      tabDescribe.style.boxShadow = 'none';
      generateSection.style.display = '';
      describeSection.style.display = 'none';
    };
    tabDescribe.onclick = function() {
      tabDescribe.classList.add('active');
      tabGenerate.classList.remove('active');
      tabDescribe.style.background = 'var(--primary)';
      tabDescribe.style.color = '#fff';
      tabDescribe.style.boxShadow = '0 4px 15px rgba(61, 90, 241, 0.3)';
      tabGenerate.style.background = 'var(--card-bg)';
      tabGenerate.style.color = 'var(--text-secondary)';
      tabGenerate.style.boxShadow = 'none';
      generateSection.style.display = 'none';
      describeSection.style.display = '';
    };

    submitBtn.onclick = async function() {
      const prompt = promptInput.value.trim();
      if (!prompt) {
        alert('è¯·è¾“å…¥æç¤ºè¯');
        return;
      }
      
      // åˆ›å»ºæ–°çš„å†å²é¡¹
      const historyItem = createHistoryItem('åˆå§‹ç”Ÿæˆ', prompt);
      
      // æµ‹è¯•æ¨¡å¼ - å½“è¾“å…¥lazymiceæ—¶æ˜¾ç¤ºéšæœºå›¾ç‰‡
      if (prompt.toLowerCase() === 'lazymice') {
        submitBtn.disabled = true;
        const resultDiv = historyItem.querySelector('.result');
        const progressBar = historyItem.querySelector('.progress-bar');
        const progressInner = progressBar.querySelector('div');
        
        // æ˜¾ç¤ºè¿›åº¦æ¡æ¨¡æ‹Ÿç”Ÿæˆè¿‡ç¨‹
        progressBar.style.display = '';
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += 5;
          progressInner.style.width = `${progress}%`;
          if (progress >= 100) {
            clearInterval(progressInterval);
            setTimeout(() => {
              progressBar.style.display = 'none';
              
              // éšæœºé€‰æ‹©ä¸€å¼ å›¾ç‰‡
              const randomImageId = Math.floor(Math.random() * 1000);
              const imageUrl = `https://picsum.photos/seed/${randomImageId}/800/600`;
              
              // æ˜¾ç¤ºéšæœºå›¾ç‰‡å’Œæ¨¡æ‹Ÿæè¿°
              let resultHTML = `<div>ç”ŸæˆæˆåŠŸï¼š</div>`;
              resultHTML += `<img src="${imageUrl}" alt="æµ‹è¯•å›¾ç‰‡" style="max-width:100%;margin-top:10px;" class="loaded-animation" />`;
              resultHTML += `<div class="description">è¿™æ˜¯ä¸€å¼ æµ‹è¯•å›¾ç‰‡ï¼Œç”±lazymiceæµ‹è¯•æ¨¡å¼ç”Ÿæˆã€‚å›¾ç‰‡ID: ${randomImageId}</div>`;
              
              // æ·»åŠ å˜åŒ–æŒ‰é’®
              resultHTML += `<div class="variation-btns">
                <div style="display:flex; align-items:center; margin-bottom:10px;">
                  <div style="margin-right:10px; font-weight:bold; white-space:nowrap;">æ”¾å¤§(UPSCALE)</div>
                  <div class="button-group">`;
              
              // æ”¾å¤§æŒ‰é’®ç»„ 1-4
              for (let i = 1; i <= 4; i++) {
                resultHTML += `<button class="btn-small btn-u" onclick="submitChange('UPSCALE', ${i}, 'test-${Date.now()}')">U${i}</button>`;
              }
              
              resultHTML += `</div></div>
                <div style="display:flex; align-items:center; margin:10px 0;">
                  <div style="margin-right:10px; font-weight:bold; white-space:nowrap;">å˜åŒ–(VARIATION)</div>
                  <div class="button-group">`;
              
              // å˜åŒ–æŒ‰é’®ç»„ 1-4
              for (let i = 1; i <= 4; i++) {
                resultHTML += `<button class="btn-small btn-v" onclick="submitChange('VARIATION', ${i}, 'test-${Date.now()}')">V${i}</button>`;
              }
              
              resultHTML += `</div></div>
                <div style="display:flex; align-items:center; margin:10px 0;">
                  <div style="margin-right:10px; font-weight:bold; white-space:nowrap;">é‡æ–°ç”Ÿæˆ</div>
                  <div class="button-group">
                    <button class="btn-reroll" onclick="submitChange('REROLL', 1, 'test-${Date.now()}')">é‡æ–°ç”Ÿæˆ</button>
                  </div>
                </div>`;
                
              resultHTML += `</div>`;
              
              resultDiv.innerHTML = resultHTML;
              submitBtn.disabled = false;
            }, 500);
          }
        }, 150);
        return;
      }
      
      submitBtn.disabled = true;
      
      let base64Array = [];
      const file = imageInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onloadend = async function() {
          base64Array = [reader.result.split(',')[1]];
          await sendRequest(prompt, base64Array, historyItem);
        };
        reader.readAsDataURL(file);
      } else {
        await sendRequest(prompt, base64Array, historyItem);
      }
    };
    
    // Describe å›¾ç”Ÿæ–‡åŠŸèƒ½
    describeBtn.onclick = async function() {
      const file = describeImageInput.files[0];
      if (!file) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡');
        return;
      }
      describeBtn.disabled = true;
      // åˆ›å»ºå†å²é¡¹
      const historyItem = createHistoryItem('å›¾ç”Ÿæ–‡', 'æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...');
      const resultDiv = historyItem.querySelector('.result');
      const progressBar = historyItem.querySelector('.progress-bar');
      const progressInner = progressBar.querySelector('div');

      // è¯»å–å›¾ç‰‡ä¸ºbase64
      const reader = new FileReader();
      reader.onloadend = async function() {
        const base64 = reader.result.split(',')[1];
        resultDiv.textContent = 'å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼Œæ­£åœ¨æäº¤Describeä»»åŠ¡ï¼Œæ—¶é—´è¾ƒé•¿ï¼Œè¯·è€å¿ƒç­‰å¾…ï¼ˆ20sï¼‰...';
        // æäº¤describeä»»åŠ¡
        try {
          const res = await fetch(API_URL + '/mj/submit/describe', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': API_TOKEN
            },
            body: JSON.stringify({ base64: 'data:image/png;base64,' + base64 })
          });
          const data = await res.json();
          if (data && data.result) {
            resultDiv.textContent = 'Describeä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆæè¿°...';
            pollDescribeStatus(data.result, historyItem);
          } else {
            resultDiv.textContent = 'Describeæäº¤å¤±è´¥ï¼š' + JSON.stringify(data);
            describeBtn.disabled = false;
          }
        } catch (e) {
          resultDiv.textContent = 'Describeè¯·æ±‚å¼‚å¸¸ï¼š' + e;
          describeBtn.disabled = false;
        }
      };
      reader.readAsDataURL(file);
    };
    
    // åˆ›å»ºå†å²é¡¹
    function createHistoryItem(title, details) {
      const historyItem = document.createElement('div');
      historyItem.className = 'history-item';
      
      const historyLabel = document.createElement('div');
      historyLabel.className = 'history-label';
      historyLabel.textContent = title;
      historyItem.appendChild(historyLabel);
      
      const resultDiv = document.createElement('div');
      resultDiv.className = 'result';
      resultDiv.textContent = `æç¤ºè¯: ${details}\nç”Ÿæˆä¸­...`;
      historyItem.appendChild(resultDiv);
      
      const progressBar = document.createElement('div');
      progressBar.className = 'progress-bar';
      progressBar.style.display = 'none';
      
      const progressInner = document.createElement('div');
      progressInner.id = 'progressInner-' + Date.now();
      progressInner.style.height = '100%';
      progressInner.style.width = '0';
      
      progressBar.appendChild(progressInner);
      historyItem.appendChild(progressBar);
      
      historyContainer.insertBefore(historyItem, historyContainer.firstChild);
      return historyItem;
    }

    async function sendRequest(prompt, base64Array, historyItem) {
      const resultDiv = historyItem.querySelector('.result');
      const progressBar = historyItem.querySelector('.progress-bar');
      const progressInner = progressBar.querySelector('div');
      
      // è·å–å½“å‰é€‰æ‹©çš„ç»˜å›¾æ¨¡å¼
      const drawingMode = document.querySelector('input[name="drawingMode"]:checked').value;
      
      try {
        // å¦‚æœæœ‰ä¸Šä¼ å›¾ç‰‡ï¼Œå…ˆä¸Šä¼ å›¾ç‰‡è·å–URL
        let imageUrl = null;
        if (base64Array.length > 0 && imageInput.files[0]) {
          resultDiv.textContent = `æç¤ºè¯: ${prompt}\næ­£åœ¨ä¸Šä¼ å›¾ç‰‡...`;
          try {
            // ä½¿ç”¨FormDataç›´æ¥ä¸Šä¼ æ–‡ä»¶
            const formData = new FormData();
            formData.append('file', imageInput.files[0]);
            
            const uploadRes = await fetch(API_URL + '/v1/files', {
              method: 'POST',
              headers: {
                'Authorization': API_TOKEN
              },
              body: formData
            });
            
            const uploadData = await uploadRes.json();
            if (uploadData && uploadData.url) {
              imageUrl = uploadData.url;
              resultDiv.textContent = `æç¤ºè¯: ${prompt}\nå›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼Œæ­£åœ¨ç”Ÿæˆ...`;
              
              // å°†å›¾ç‰‡URLæ·»åŠ åˆ°æç¤ºè¯åé¢ï¼Œä¸­é—´åŠ ç©ºæ ¼
              prompt = `${prompt} ${imageUrl}`;
              resultDiv.textContent += `\næ–°æç¤ºè¯: ${prompt}`;
            } else {
              resultDiv.textContent = `æç¤ºè¯: ${prompt}\nå›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${JSON.stringify(uploadData)}`;
              submitBtn.disabled = false;
              return;
            }
          } catch (uploadErr) {
            resultDiv.textContent = `æç¤ºè¯: ${prompt}\nå›¾ç‰‡ä¸Šä¼ å¼‚å¸¸: ${uploadErr}`;
            submitBtn.disabled = false;
            return;
          }
        }
        
        // æ ¹æ®ä¸åŒçš„ç»˜å›¾æ¨¡å¼ï¼Œé€‰æ‹©ä¸åŒçš„APIæ¥å…¥ç‚¹å‰ç¼€
        let apiPrefix = '';
        if (drawingMode === 'fast') {
          apiPrefix = '/mj-fast';
          resultDiv.textContent += `\nå·²é€‰æ‹©Fastæ¨¡å¼`;
        } else if (drawingMode === 'turbo') {
          apiPrefix = '/mj-turbo';  // å¦‚æœæ–‡æ¡£ä¸­æ²¡æœ‰æ˜ç¡®æŒ‡å‡ºturboæ¨¡å¼çš„å‰ç¼€ï¼Œè¿™é‡Œå‡è®¾æ˜¯/mj-turbo
          resultDiv.textContent += `\nå·²é€‰æ‹©Turboæ¨¡å¼`;
        } else {
          apiPrefix = '/mj-relax';  // é»˜è®¤ä¸ºrelaxæ¨¡å¼
          resultDiv.textContent += `\nå·²é€‰æ‹©Relaxæ¨¡å¼`;
        }
        
        // ç»„è£…è¯·æ±‚ä½“
        const body = { prompt };
        
        // å‘é€è¯·æ±‚åˆ°å¯¹åº”æ¨¡å¼çš„APIæ¥å…¥ç‚¹
        const res = await fetch(API_URL + apiPrefix + '/mj/submit/imagine', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': API_TOKEN
          },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (data && data.result) {
          resultDiv.textContent = `æç¤ºè¯: ${prompt}\nä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆ...ï¼ˆ${drawingMode}æ¨¡å¼ï¼‰`;
          currentTaskId = data.result;
          pollTaskStatus(data.result, historyItem);
        } else {
          resultDiv.textContent = `æç¤ºè¯: ${prompt}\næäº¤å¤±è´¥ï¼š${JSON.stringify(data)}`;
          submitBtn.disabled = false;
        }
      } catch (e) {
        resultDiv.textContent = `æç¤ºè¯: ${prompt}\nè¯·æ±‚å¤±è´¥ï¼š${e}`;
        submitBtn.disabled = false;
      }
    }

    // è½®è¯¢ä»»åŠ¡çŠ¶æ€
    function pollTaskStatus(taskId, historyItem) {
      const resultDiv = historyItem.querySelector('.result');
      const progressBar = historyItem.querySelector('.progress-bar');
      const progressInner = progressBar.querySelector('div');
      
      // ä¿å­˜åˆ›å»ºä»»åŠ¡æ—¶çš„ç»˜å›¾æ¨¡å¼ï¼Œç¡®ä¿åç»­æŸ¥è¯¢ä½¿ç”¨ç›¸åŒçš„æ¨¡å¼
      const drawingMode = document.querySelector('input[name="drawingMode"]:checked').value;
      
      let totalTime = 30; // é»˜è®¤30ç§’
      let intervalTime = 3000; // é»˜è®¤3ç§’æŸ¥è¯¢ä¸€æ¬¡
      let estimatedSteps = totalTime / (intervalTime / 1000);
      
      let intervalCount = 0;
      let interval = setInterval(async () => {
        intervalCount++;
        // è¿›åº¦æ¡æ˜¾ç¤ºå¹¶æ›´æ–°
        progressBar.style.display = '';
        let percent = Math.min(95, (intervalCount / estimatedSteps) * 100);
        progressInner.style.width = percent + '%';
        try {
          // æ ¹æ®å½“å‰çš„ç»˜å›¾æ¨¡å¼ç¡®å®šAPIå‰ç¼€
          let apiPrefix = '';
          if (drawingMode === 'fast') {
            apiPrefix = '/mj-fast';
          } else if (drawingMode === 'turbo') {
            apiPrefix = '/mj-turbo';
          } else {
            apiPrefix = '/mj-relax';
          }
          
          // ä½¿ç”¨æ–°çš„ä»»åŠ¡æŸ¥è¯¢API
          const res = await fetch(API_URL + apiPrefix + `/mj/task/${taskId}/fetch`, {
            method: 'GET',
            headers: {
              'Authorization': API_TOKEN
            }
          });
          
          const task = await res.json();
          
          // å¤„ç†å“åº”æ•°æ®
          if (task) {
            if (task.status === 'SUCCESS') {
              clearInterval(interval);
              progressInner.style.width = '100%';
              setTimeout(()=>{progressBar.style.display='none';}, 800);
              
              // æ˜¾ç¤ºå›¾ç‰‡ã€æè¿°å’Œå˜åŒ–æŒ‰é’®
              let resultHTML = `<div>ç”ŸæˆæˆåŠŸï¼š</div>`;
              resultHTML += `<img src="${task.imageUrl}" alt="AIç»˜ç”»ç»“æœ" style="max-width:100%;margin-top:10px;" class="loaded-animation" />`;
              
              // æ·»åŠ æè¿°ä¿¡æ¯
              if (task.description) {
                resultHTML += `<div class="description">${task.description}</div>`;
              }
              
              // æ·»åŠ å˜åŒ–æŒ‰é’®
              resultHTML += `<div class="variation-btns">
                <div style="display:flex; align-items:center; margin-bottom:10px;">
                  <div style="margin-right:10px; font-weight:bold; white-space:nowrap;">æ”¾å¤§(UPSCALE)</div>
                  <div class="button-group">`;
              
              // æ”¾å¤§æŒ‰é’®ç»„ 1-4
              for (let i = 1; i <= 4; i++) {
                resultHTML += `<button class="btn-small btn-u" onclick="submitChange('UPSCALE', ${i}, '${task.id}')">U${i}</button>`;
              }
              
              resultHTML += `</div></div>
                <div style="display:flex; align-items:center; margin:10px 0;">
                  <div style="margin-right:10px; font-weight:bold; white-space:nowrap;">å˜åŒ–(VARIATION)</div>
                  <div class="button-group">`;
              
              // å˜åŒ–æŒ‰é’®ç»„ 1-4
              for (let i = 1; i <= 4; i++) {
                resultHTML += `<button class="btn-small btn-v" onclick="submitChange('VARIATION', ${i}, '${task.id}')">V${i}</button>`;
              }
              
              resultHTML += `</div></div>
                <div style="display:flex; align-items:center; margin:10px 0;">
                  <div style="margin-right:10px; font-weight:bold; white-space:nowrap;">é‡æ–°ç”Ÿæˆ</div>
                  <div class="button-group">
                    <button class="btn-reroll" onclick="submitChange('REROLL', 1, '${task.id}')">é‡æ–°ç”Ÿæˆ</button>
                  </div>
                </div>`;
                
              resultHTML += `</div>`;
              
              resultDiv.innerHTML = resultHTML;
              submitBtn.disabled = false;
            } else if (task.status === 'FAILURE') {
              clearInterval(interval);
              progressInner.style.width = '0';
              setTimeout(()=>{progressBar.style.display='none';}, 800);
              resultDiv.textContent = 'ç”Ÿæˆå¤±è´¥ï¼š' + (task.failReason || 'æœªçŸ¥é”™è¯¯');
              submitBtn.disabled = false;
            } else {
              // æ˜¾ç¤ºå½“å‰çŠ¶æ€å’Œæè¿°ä¿¡æ¯
              let statusText = 'ç”Ÿæˆä¸­... å½“å‰çŠ¶æ€ï¼š' + (task.status || 'æœªçŸ¥');
              
              // å°†è¿›åº¦ç™¾åˆ†æ¯”æ”¾åœ¨çŠ¶æ€å³ä¾§
              if (task.progress) {
                statusText = `<div style="display:flex; justify-content:space-between; align-items:center;">
                  <div>ç”Ÿæˆä¸­... å½“å‰çŠ¶æ€ï¼š${task.status || 'æœªçŸ¥'}</div>
                  <div style="font-family:'Rajdhani',sans-serif; font-size:20px; font-weight:bold;">
                    <span style="color:var(--accent);">${task.progress}</span> å®Œæˆ
                  </div>
                </div>`;
              }
              
              // å¦‚æœæœ‰æè¿°ä¿¡æ¯ï¼Œå¤„ç†å¹¶è°ƒæ•´è¿›åº¦æ¡æ—¶é—´
              if (task.description) {
                statusText += `<div class="description">${task.description}</div>`;
                
                // åˆ¤æ–­æ’é˜Ÿæ•°é‡
                const queueMatch = task.description.match(/å‰é¢è¿˜æœ‰(\d+)å¼ æ’é˜Ÿ/);
                if (queueMatch) {
                  const queueCount = parseInt(queueMatch[1], 10);
                  // æ ¹æ®æ’é˜Ÿæ•°é‡è°ƒæ•´æ€»æ—¶é—´å’Œé¢„è®¡æ­¥æ•°
                  if (!isNaN(queueCount)) {
                    const newTotalTime = queueCount * 30; // æ¯å¼ å›¾30ç§’
                    
                    // åªåœ¨é¦–æ¬¡æ£€æµ‹åˆ°æ’é˜Ÿä¿¡æ¯æ—¶æ›´æ–°ï¼Œé¿å…é‡å¤è°ƒæ•´
                    if (totalTime === 30) { // è¿˜æ˜¯é»˜è®¤å€¼æ—¶æ‰æ›´æ–°
                      totalTime = newTotalTime;
                      estimatedSteps = totalTime / (intervalTime / 1000);
                      console.log(`æ£€æµ‹åˆ°${queueCount}å¼ å›¾ç‰‡æ’é˜Ÿï¼Œé¢„è®¡ç­‰å¾…æ—¶é—´: ${totalTime}ç§’`);
                    }
                  }
                }
                
                // æ›´æ–°è¿›åº¦æ¡ï¼Œè€ƒè™‘å·²ç»è¿‡å»çš„æ—¶é—´
                percent = Math.min(95, (intervalCount / estimatedSteps) * 100);
                progressInner.style.width = percent + '%';
              }
              
              resultDiv.innerHTML = statusText;
            }
          } else {
            resultDiv.textContent = 'æŸ¥è¯¢ä»»åŠ¡å¤±è´¥ï¼šæ— æ•ˆçš„å“åº”æ•°æ®';
          }
        } catch (e) {
          resultDiv.textContent = 'æŸ¥è¯¢ä»»åŠ¡å¼‚å¸¸ï¼š' + e;
        }
      }, intervalTime);
    }

    // è½®è¯¢Describeä»»åŠ¡çŠ¶æ€
    function pollDescribeStatus(taskId, historyItem) {
      const resultDiv = historyItem.querySelector('.result');
      const progressBar = historyItem.querySelector('.progress-bar');
      const progressInner = progressBar.querySelector('div');
      let interval = setInterval(async () => {
        progressBar.style.display = '';
        progressInner.style.width = '80%';
        try {
          const res = await fetch(API_URL + `/mj/task/${taskId}/fetch`, {
            method: 'GET',
            headers: { 'Authorization': API_TOKEN }
          });
          const task = await res.json();
          if (task) {
            if (task.status === 'SUCCESS') {
              clearInterval(interval);
              progressInner.style.width = '100%';
              setTimeout(()=>{progressBar.style.display='none';}, 800);

              // åˆ¤æ–­descriptionæ˜¯å¦ä¸ºæ— æ•ˆå†…å®¹
              function isInvalidDesc(desc) {
                if (!desc) return true;
                const invalids = ['æäº¤æˆåŠŸ', 'success', 'å·²æäº¤', 'successfully', ''];
                return invalids.includes(desc.trim().toLowerCase());
              }

              let desc = '';
              if (task.promptEn && task.promptEn.trim()) {
                desc = task.promptEn.trim();
              } else if (task.finalPrompt && task.finalPrompt.trim()) {
                desc = task.finalPrompt.trim();
              } else if (!isInvalidDesc(task.description)) {
                desc = task.description.trim();
              } else {
                desc = 'æ— æè¿°è¿”å›';
              }

              // åˆ¤æ–­æ˜¯å¦ä¸ºå¤šæ¡è‹±æ–‡æç¤ºè¯ï¼ˆå¦‚promptEnæœ‰4æ¡ï¼‰
              let html = '<div>å›¾ç”Ÿæ–‡ç»“æœï¼š</div>';
              if (desc !== 'æ— æè¿°è¿”å›' && (desc.match(/^\d+ï¸âƒ£/) || desc.split('\n').length >= 4)) {
                // æŒ‰è¡Œåˆ†å‰²ï¼Œè¿‡æ»¤ç©ºè¡Œ
                let lines = desc.split(/\n+/).filter(line => line.trim());
                lines.forEach((line, idx) => {
                  // å»é™¤å‰ç¼€åºå·å’Œç©ºæ ¼
                  let text = line.replace(/^\d+ï¸âƒ£\s*/, '');
                  html += `<div style="display:flex;align-items:center;margin-bottom:6px;">
                    <span class="description" id="describeText${idx}" style="white-space:pre-line;flex:1;">${text}</span>
                    <button class="copyDescribeBtn" data-idx="${idx}" style="margin-left:8px;font-size:18px;cursor:pointer;background:none;border:none;">ğŸ“‹</button>
                  </div>`;
                });
              } else {
                html += `<div class="description" id="describeText0" style="white-space:pre-line;">${desc}</div>
                  <button class="copyDescribeBtn" data-idx="0" style="margin-top:8px;font-size:18px;cursor:pointer;background:none;border:none;">ğŸ“‹</button>`;
              }
              resultDiv.innerHTML = html;
              // å¤åˆ¶åŠŸèƒ½
              const copyBtns = resultDiv.querySelectorAll('.copyDescribeBtn');
              copyBtns.forEach(btn => {
                btn.onclick = function() {
                  const idx = btn.getAttribute('data-idx');
                  const text = resultDiv.querySelector(`#describeText${idx}`).innerText;
                  navigator.clipboard.writeText(text).then(()=>{
                    btn.textContent = 'âœ…';
                    setTimeout(()=>{btn.textContent = 'ğŸ“‹';}, 1200);
                  });
                };
              });
              describeBtn.disabled = false;
            } else if (task.status === 'FAILURE') {
              clearInterval(interval);
              progressInner.style.width = '0';
              setTimeout(()=>{progressBar.style.display='none';}, 800);
              resultDiv.textContent = 'Describeç”Ÿæˆå¤±è´¥ï¼š' + (task.failReason || 'æœªçŸ¥é”™è¯¯');
              describeBtn.disabled = false;
            } else {
              resultDiv.textContent = 'Describeç”Ÿæˆä¸­... å½“å‰çŠ¶æ€ï¼š' + (task.status || 'æœªçŸ¥');
            }
          } else {
            resultDiv.textContent = 'Describeä»»åŠ¡æŸ¥è¯¢å¤±è´¥ï¼šæ— æ•ˆå“åº”';
          }
        } catch (e) {
          resultDiv.textContent = 'Describeä»»åŠ¡æŸ¥è¯¢å¼‚å¸¸ï¼š' + e;
        }
      }, 3000);
    }

    // æäº¤å˜åŒ–è¯·æ±‚
    function submitChange(action, index, taskId) {
      // åˆ›å»ºåŒ…å«æ“ä½œç±»å‹å’Œåºå·çš„å†å²é¡¹
      const operationTypes = {
        'UPSCALE': 'æ”¾å¤§',
        'VARIATION': 'å˜åŒ–', 
        'REROLL': 'é‡æ–°ç”Ÿæˆ'
      };
      
      const historyItem = createHistoryItem(`${operationTypes[action]} ${index}`, `åŸºäºä¸Šä¸€å¼ å›¾ç‰‡çš„${operationTypes[action]}æ“ä½œ`);
      
      const resultDiv = historyItem.querySelector('.result');
      submitBtn.disabled = true;
      
      handleChange(action, index, taskId, historyItem);
    }
    
    // å¤„ç†å˜åŒ–è¯·æ±‚
    async function handleChange(action, index, taskId, historyItem) {
      const resultDiv = historyItem.querySelector('.result');
      const progressBar = historyItem.querySelector('.progress-bar');
      const progressInner = progressBar.querySelector('div');
      
      // è·å–å½“å‰é€‰æ‹©çš„ç»˜å›¾æ¨¡å¼
      const drawingMode = document.querySelector('input[name="drawingMode"]:checked').value;
      
      try {
        // æ ¹æ®å½“å‰çš„ç»˜å›¾æ¨¡å¼ç¡®å®šAPIå‰ç¼€
        let apiPrefix = '';
        if (drawingMode === 'fast') {
          apiPrefix = '/mj-fast';
        } else if (drawingMode === 'turbo') {
          apiPrefix = '/mj-turbo';
        } else {
          apiPrefix = '/mj-relax';
        }
        
        const body = {
          action: action,
          index: index,
          taskId: taskId
        };
        
        const res = await fetch(API_URL + apiPrefix + '/mj/submit/change', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': API_TOKEN
          },
          body: JSON.stringify(body)
        });
        
        const data = await res.json();
        if (data && data.result) {
          resultDiv.textContent = 'å˜åŒ–è¯·æ±‚å·²æäº¤ï¼Œæ­£åœ¨å¤„ç†...';
          currentTaskId = data.result;  // æ›´æ–°ä¸ºæ–°çš„ä»»åŠ¡ID
          pollTaskStatus(data.result, historyItem);
        } else {
          resultDiv.textContent = 'å˜åŒ–è¯·æ±‚å¤±è´¥ï¼š' + JSON.stringify(data);
          submitBtn.disabled = false;
        }
      } catch (e) {
        resultDiv.textContent = 'å˜åŒ–è¯·æ±‚å¼‚å¸¸ï¼š' + e;
        submitBtn.disabled = false;
      }
    }
  </script>
</body>
</html> 